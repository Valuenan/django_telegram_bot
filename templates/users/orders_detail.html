{% extends 'base.html' %}
{% load static shop_tags %}

{% block content %}
{% if new_message %}
    <div><audio hidden autoplay controls src="{% static 'audio/zvonok-kak-v-kolokolchik.mp3' %}"></audio></div>
{% endif %}
    <a href="/">Вернуться к заказам</a>
    <form action="" method="post" class="mt-4" id="formReview">
        {% csrf_token %}
        <h1>Заказ №{{ order.id }}</h1>
        <p>Дата: {{ order.date }}</p>
        <p>Ник в телеграм: {{ order.profile.telegram_name }}</p>
        <p>ФИО: {{ order.profile.user.first_name }} {{ order.profile.user.last_name }}</p>
        <p>Номер телефона: {{ order.profile.phone }}</p>
        <p>Доставка: {% if order.deliver %}
                    да
                {% else %}
                    нет
                {% endif %}
        </p>
        <p>Адрес: {{ order.delivery_info }} | Изменить адрес: <input type="text" name="delivery_info" value="{{ order.delivery_info }}"></p>

            <p>Статус:
                <select name="new_status">
                    {% for status in order_statuses %}
                        <option
                                {% if status == order.status %} selected {% endif %}
                                value="{{ status.title }}">{{ status }}</option>
                    {% endfor %}
                </select>
            </p>
            </p>Магазин списания/возврата:
                <select name="shop">
                    {% for shop in shops %}
                        <option
                                {% if shop == order.profile.main_shop %} selected {% endif %}

                                value="{{ shop.id }}">{{ shop }}</option>
                    {% endfor %}
                </select>
            <table border="1px">
                <tr>
                    <td>Название</td>
                    <td>Количество</td>
                    {% for shop in shops %}
                        <td {% if order.profile.main_shop == shop %} bgcolor="green" {% endif %}> {{ shop }}</td>
                    {% endfor %}
                    <td>Стоимость за шт.</td>
                    <td><b>Сумма</b></td>
                </tr>
                {% for product in products %}
                <tr>
                    <td {% if product.soft_delete %} bgcolor="red" {% endif %}>
                        {{ product.product.name }} </td>
                    <td> <input
                            {% if order.status.title != "0" %} disabled {% endif %}
                                name="{{ product.id }}" id="contactparent" value="{% formatted_float product.amount %} "></td>
                    {% for rest in product.product.rests_set.all %}
                        <td {% if product.amount > rest.amount %} bgcolor="yellow" {% endif %}>
                            {% formatted_float rest.amount %} шт.</td>
                    {% endfor %}
                    {% if product.product.sale %}
                        <td> {% get_sum 1 product.price order.discount %} р.</td>
                    <td> <b>{% get_sum product.amount product.price order.discount %} р.</b></td>
                    {% else %}
                        <td> {% formatted_float product.price %} р.</td>
                        <td> <b>{% get_sum product.amount product.price %} р.</b></td>
                    {% endif %}
                </tr>
                {% endfor %}
                {% if order.deliver %}
                    <tr>
                        <td>
                        Стоимость доставки
                        <input {% if order.status.title != "0" and order.delivery_price != 0 %} disabled {% endif %}
                            type="number" name="delivery_price" value="{{ order.delivery_price }}">
                        </td>
                    </tr>
                    {% if order.status.title != "0" %}
                    <tr>
                        <td>
                        Трек номер
                        <input type="text" name="tracing_num" value="{{ order.tracing_num }}">
                        </td>
                    </tr>
                    {% endif %}
                {% endif %}
            </table>
            <button type="submit">Записать</button>
        </form>
        {% if order.discount < 1 %}
            <p>Сумма со скидкой {% get_discount order.discount %}%: {{ order_sum }} р.</p>
        {% else %}
            <p>Сумма: {{ order_sum }} р.</p>
        {% endif %}

        <p> {% if not order.admin_check %}
            Обработанна: -
        {% else %}
            Обработанна: {{ order.admin_check.first_name }} {{ order.admin_check.last_name }}
        {% endif %}
        </p>
    <br>
    <h2>Общение с пользователем</h2>
    <a href="{% url 'user_messages_detail' order.profile.chat_id %}">Перейти к сообщениям пользователя</a>
    <form class="form" action="{% url 'send_message' %}" method="post">
       {% csrf_token %}
        <input hidden type="text" name="chat_id" value="{{ order.profile.chat_id }}">
        <p>Сообщение: <textarea name="message"></textarea></p>
        <p>Тихое уведомление: <input name="disable_notification" type="checkbox" checked></p>
        <button type="submit">Отправить</button>
    </form>
{% endblock %}